var WebRTCO=function(b){var s=null;var d=null;var u=null;var p=null;var q=null;var h=false;var k=null;var c;var g=null;var n=null;this.API_getRoomID=function(){return g.getRoomID()};this.API_sendPutChatMsg=function(v){g.sendPublicChatMessage(v)};this.API_isMicMuted=function(){return g.isMicMuted()};this.API_muteMic=function(v){g.muteMic(v)};this.API_isCamMuted=function(){return g.isCamMuted()};this.API_muteCam=function(v){g.muteCam(v)};window.onbeforeunload=function(){g.sendByeMessage()};var f={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};var a=function(v){if(h){window.console.log(v)}};this.setDebug=function(v){h=v};var j=function(v){var y=v.split("\r\n");for(var x=0;x<y.length;x++){if(y[x].search("m=audio")!==-1){var z=x;break}}if(z===null){return v}for(x=0;x<y.length;x++){if(y[x].search("opus/48000")!==-1){var w=l(y[x],/:(\d+) opus\/48000/i);if(w){y[z]=o(y[z],w)}break}}y=m(y,z);v=y.join("\r\n");return v};var l=function(w,x){var v=w.match(x);return(v&&v.length==2)?v[1]:null};var o=function(w,z){var y=w.split(" ");var A=new Array();var v=0;for(var x=0;x<y.length;x++){if(v===3){A[v++]=z}if(y[x]!==z){A[v++]=y[x]}}return A.join(" ")};var m=function(w,A){var y=w[A].split(" ");for(var v=w.length-1;v>=0;v--){var z=l(w[v],/a=rtpmap:(\d+) CN\/\d+/i);if(z){var x=y.indexOf(z);if(x!==-1){y.splice(x,1)}w.splice(v,1)}}w[A]=y.join(" ");return w};var t=function(y){var F;var M;var L=null;var D={};var K=null;var G=y.roomID||"room";var I=y.onMessageReceived;var B=y.onRoomReceived;var J=y.onRemoteVideoReceived;var E=y.onBye;this.getRoomID=function(){return G};this.muteMic=function(Q){var N=L.getAudioTracks();for(var P=0,O=N.length;P<O;P++){N[P].enabled=!Q}};this.isMicMuted=function(){var N=L.getAudioTracks();return !(N[0].enabled)};this.muteCam=function(Q){var P=L.getVideoTracks();for(var O=0,N=P.length;O<N;O++){P[O].enabled=!Q}};this.isCamMuted=function(){var N=L.getVideoTracks();return !(N[0].enabled)};var v=function(){var N=window.location.search;var O={};N.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(Q,P,S,R){O[P]=R});return O};var C=function(){a("Channel opened...");F=true;var N=v();if(N[G]){k=N[G];z({type:"ROOM_ENTER",value:k*1});c=true}else{z({type:"ROOM_CREATE",value:""});c=false}};var H=function(N){a("S->C: "+N.data);A(N.data)};var x=function(){a("Channel error.")};var w=function(){a("Channel closed.");F=false};this.sendByeMessage=function(){z({type:"bye",from:K})};var z=function(N){if(!F){return}var O=JSON.stringify(N);a("C->S: "+O);M.send(O)};var A=function(R){var S=JSON.parse(R);if(S.type==="TOPEER"){var P=S.from;var N=S.to;S=S.packet;var Q=D[P];if(undefined===Q){a("undefined pid "+P);if(S.type==="PLEASE_CALL"){a("pid "+P+"asked for call");var T=J(P);var Q=new r(T,L,P,K,z);D[P]=Q;Q.doCall()}else{return}}if(S.type==="offer"){Q.onOffer(S)}else{if(S.type==="answer"){Q.onAnswer(S)}else{if(S.type==="candidate"){Q.onCandidate(S)}}}}else{if(S.type==="CHATMSG"){if(null===I){return}I(S.value)}else{if(S.type==="bye"){if(null!==E){E(S.from)}}else{if(S.type==="ROOM_ENTERED"){k=S.value;K=S.pid;a("received room number: "+k);if(null!==B&&!c){B(k)}c=false}else{if(S.type==="ROOM_LEAVE"){window.location.href="/"}else{if(S.type==="PEER_JOINED"){var O=S.pid;a("peer joined: "+O);var T=J(O);var Q=new r(T,L,O,K,z);D[O]=Q;var S={type:"PLEASE_CALL"};z({type:"TOPEER",from:K,to:O,packet:S})}}}}}}};this.sendPublicChatMessage=function(N){if(!F){return}z({type:"CHATMSG",value:N})};this.go=function(N){L=N;F=false;M=new WebSocket(y.signalingURL);M.onopen=C;M.onerror=x;M.onmessage=H;M.onclose=w}};var i=function(v,A){var B=null;var z=null;var w=function(){var D={audio:true,video:{mandatory:{},optional:[]}};try{a('Requested access to local media with mediaConstraints:\n "'+JSON.stringify(D)+'"');d(D,y,x)}catch(C){a("getUserMedia failed with exception: "+C.message)}};var y=function(C){a("User has granted access to local media.");u(z,C);z.muted=true;z.play();B=C;A(C)};var x=function(C){a("Failed to get access to local media. Error code was "+C.code)};z=v;w()};var r=function(C,E,I,J,A){var y=A;var O=E;var M=C;var N=I;var H=J;var x={iceServers:[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"},{url:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{url:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]};var z=function(Q){y({type:"TOPEER",from:H,to:N,packet:Q})};var D=function(Q){if(Q.candidate){z({type:"candidate",label:Q.candidate.sdpMLineIndex,id:Q.candidate.sdpMid,candidate:Q.candidate.candidate})}else{a("End of candidates.")}};var P=function(Q){a("Remote stream added.");u(M,Q.stream);M.play()};var B=function(Q){a("Remote stream removed.")};this.doCall=function(){var Q={optional:[],mandatory:[]};a('Sending offer to peer, with constraints: \n  "'+JSON.stringify(Q)+'".');v.createOffer(K,w,Q)};var G=function(){a("Sending answer to peer.");v.createAnswer(K,w,f)};var w=function(Q){a("Something wrong happened when answer or offer "+Q.toString())};var K=function(Q){Q.sdp=j(Q.sdp);v.setLocalDescription(Q);z(Q)};this.onOffer=function(Q){v.setRemoteDescription(new RTCSessionDescription(Q));G()};this.onAnswer=function(Q){v.setRemoteDescription(new RTCSessionDescription(Q))};this.onCandidate=function(R){var Q=new RTCIceCandidate({sdpMLineIndex:R.label,candidate:R.candidate});v.addIceCandidate(Q)};var F=null;var v=null;try{v=new s(x,F);v.onicecandidate=D;a('Created RTCPeerConnnection with:\n  config: "'+JSON.stringify(x)+'";\n  constraints: "'+JSON.stringify(F)+'".')}catch(L){v=null;a("Failed to create PeerConnection, exception: "+L.message);return}v.onaddstream=P;v.onremovestream=B;a("my stream is: "+O);v.addStream(O)};var e=function(){if(navigator.mozGetUserMedia){q="firefox";s=mozRTCPeerConnection;RTCSessionDescription=mozRTCSessionDescription;RTCIceCandidate=mozRTCIceCandidate;d=navigator.mozGetUserMedia.bind(navigator);u=function(v,w){v.mozSrcObject=w;v.play()};p=function(w,v){w.mozSrcObject=v.mozSrcObject;w.play()};return true}else{if(navigator.webkitGetUserMedia){q="chrome";s=webkitRTCPeerConnection;d=navigator.webkitGetUserMedia.bind(navigator);u=function(v,w){v.src=webkitURL.createObjectURL(w)};p=function(w,v){w.src=v.src};if(!webkitMediaStream.prototype.getVideoTracks){webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks};webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}}if(!webkitRTCPeerConnection.prototype.getLocalStreams){webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams};webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams}}return true}else{return false}}};e();g=new t(b);n=new i(b.localVideo,g.go)};